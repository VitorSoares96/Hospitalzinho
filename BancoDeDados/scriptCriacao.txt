-- ========================================================
-- Script completo PostgreSQL para as entidades do Hospitalzinho
-- IDs via SEQUENCE; enums como INTEGER NOT NULL
-- ========================================================

-- ========================
-- SEQUENCES
-- ========================
CREATE SEQUENCE seq_hospital START 1;
CREATE SEQUENCE seq_hospital_endereco START 1;
CREATE SEQUENCE seq_hospital_unidade START 1;

CREATE SEQUENCE seq_ala START 1;
CREATE SEQUENCE seq_quarto START 1;
CREATE SEQUENCE seq_sala START 1;

CREATE SEQUENCE seq_especialidade START 1;
CREATE SEQUENCE seq_profissional START 1;

CREATE SEQUENCE seq_paciente START 1;
CREATE SEQUENCE seq_prontuario START 1;
CREATE SEQUENCE seq_paciente_contato START 1;
CREATE SEQUENCE seq_paciente_endereco START 1;
CREATE SEQUENCE seq_paciente_convenio START 1;

CREATE SEQUENCE seq_convenio START 1;

CREATE SEQUENCE seq_exame_tipo START 1;
CREATE SEQUENCE seq_paciente_exame START 1;

CREATE SEQUENCE seq_consulta START 1;
CREATE SEQUENCE seq_cirurgia START 1;
CREATE SEQUENCE seq_internacao START 1;

CREATE SEQUENCE seq_doenca_modelo START 1;
CREATE SEQUENCE seq_paciente_doenca START 1;

CREATE SEQUENCE seq_alergia START 1;

CREATE SEQUENCE seq_medicamento_modelo START 1;
CREATE SEQUENCE seq_medicamento START 1;

CREATE SEQUENCE seq_receita START 1;
CREATE SEQUENCE seq_item_receita START 1;
CREATE SEQUENCE seq_paciente_medicacao START 1;

CREATE SEQUENCE seq_vacina_modelo START 1;
CREATE SEQUENCE seq_vacina START 1;
CREATE SEQUENCE seq_paciente_vacinacao START 1;

-- ========================
-- HOSPITAL / ENDEREÇO / UNIDADE
-- ========================
CREATE TABLE hospital (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_hospital'),
    nome VARCHAR(255) NOT NULL,
    cnes VARCHAR(50) NOT NULL,
    cnpj VARCHAR(20) NOT NULL,
    token_acesso VARCHAR(255) NOT NULL
);

CREATE TABLE hospital_endereco (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_hospital_endereco'),
    cep VARCHAR(20),
    cidade VARCHAR(100),
    bairro VARCHAR(100),
    rua VARCHAR(150),
    numero VARCHAR(20),
    complemento VARCHAR(100)
);

CREATE TABLE hospital_unidade (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_hospital_unidade'),
    nome VARCHAR(255) NOT NULL,
    tipo_unidade INTEGER NOT NULL,
    endereco_id BIGINT REFERENCES hospital_endereco(id) ON DELETE SET NULL,
    instituicao_pai_id BIGINT NOT NULL REFERENCES hospital(id) ON DELETE CASCADE
);

CREATE INDEX idx_hospital_unidade_instituicao ON hospital_unidade(instituicao_pai_id);

-- ========================
-- ESTRUTURA FÍSICA: ALA / QUARTO / SALA
-- ========================
CREATE TABLE ala (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_ala'),
    nome VARCHAR(150) NOT NULL,
    hospital_unidade_id BIGINT NOT NULL REFERENCES hospital_unidade(id) ON DELETE CASCADE
);

CREATE TABLE quarto (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_quarto'),
    numero VARCHAR(50),
    ala_id BIGINT NOT NULL REFERENCES ala(id) ON DELETE CASCADE,
    tipo INTEGER NOT NULL,
    capacidade INTEGER NOT NULL
);

CREATE TABLE sala (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_sala'),
    numero VARCHAR(50),
    ala_id BIGINT NOT NULL REFERENCES ala(id) ON DELETE CASCADE,
    tipo INTEGER NOT NULL
);

-- ========================
-- ESPECIALIDADE / PROFISSIONAL
-- ========================
CREATE TABLE especialidade (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_especialidade'),
    nome VARCHAR(200) NOT NULL
);

CREATE TABLE profissional_saude (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_profissional'),
    nome VARCHAR(200) NOT NULL,
    registro_profissional VARCHAR(50) NOT NULL,
    especialidade_id BIGINT NOT NULL REFERENCES especialidade(id) ON DELETE RESTRICT,
    hospital_unidade_id BIGINT NOT NULL REFERENCES hospital_unidade(id) ON DELETE RESTRICT
);

CREATE INDEX idx_profissional_especialidade ON profissional_saude(especialidade_id);
CREATE INDEX idx_profissional_unidade ON profissional_saude(hospital_unidade_id);

-- ========================
-- PACIENTE / PRONTUÁRIO / CONTATOS / ENDEREÇOS / CONVENIOS
-- ========================
CREATE TABLE paciente (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_paciente'),
    nome VARCHAR(255) NOT NULL,
    cns VARCHAR(20) NOT NULL,
    cpf VARCHAR(20),
    data_nascimento DATE,
    nome_pai VARCHAR(255),
    nome_mae VARCHAR(255),
    cpf_pai VARCHAR(20),
    cpf_mae VARCHAR(20),
    ativo BOOLEAN DEFAULT TRUE,
    sexo INTEGER NOT NULL,
    nacionalidade VARCHAR(100),
    raca INTEGER NOT NULL,
    naturalidade VARCHAR(100),
    escolaridade INTEGER NOT NULL,
    data_cadastro TIMESTAMP WITHOUT TIME ZONE DEFAULT now(),
    data_atualizacao TIMESTAMP WITHOUT TIME ZONE DEFAULT now()
);

CREATE TABLE paciente_prontuario (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_prontuario'),
    paciente_id BIGINT NOT NULL UNIQUE REFERENCES paciente(id) ON DELETE CASCADE,
    tipo_sangue INTEGER NOT NULL,
    data_abertura TIMESTAMP WITHOUT TIME ZONE DEFAULT now(),
    ultima_atualizacao TIMESTAMP WITHOUT TIME ZONE DEFAULT now()
);

CREATE TABLE paciente_contato (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_paciente_contato'),
    paciente_id BIGINT NOT NULL REFERENCES paciente(id) ON DELETE CASCADE,
    telefone_residencial VARCHAR(30),
    telefone_celular VARCHAR(30),
    email VARCHAR(255)
);

CREATE INDEX idx_paciente_contato_paciente ON paciente_contato(paciente_id);

CREATE TABLE paciente_endereco (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_paciente_endereco'),
    paciente_id BIGINT NOT NULL REFERENCES paciente(id) ON DELETE CASCADE,
    logradouro VARCHAR(255),
    numero VARCHAR(50),
    complemento VARCHAR(100),
    bairro VARCHAR(100),
    cidade VARCHAR(100),
    estado VARCHAR(2),
    cep VARCHAR(20)
);

CREATE INDEX idx_paciente_endereco_paciente ON paciente_endereco(paciente_id);

CREATE TABLE convenio (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_convenio'),
    nome VARCHAR(255) NOT NULL,
    cnpj VARCHAR(20),
    registro_ans VARCHAR(50)
);

CREATE TABLE paciente_convenio (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_paciente_convenio'),
    paciente_id BIGINT NOT NULL REFERENCES paciente(id) ON DELETE CASCADE,
    convenio_id BIGINT NOT NULL REFERENCES convenio(id) ON DELETE CASCADE,
    numero_carteira VARCHAR(100) NOT NULL,
    validade DATE,
    ativo BOOLEAN DEFAULT TRUE,
    UNIQUE (paciente_id, convenio_id)
);

CREATE INDEX idx_paciente_convenio_paciente ON paciente_convenio(paciente_id);
CREATE INDEX idx_paciente_convenio_convenio ON paciente_convenio(convenio_id);

-- ========================
-- EXAMES (tipos) e PacienteExame
-- ========================
CREATE TABLE exame_tipo (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_exame_tipo'),
    nome VARCHAR(200) NOT NULL,
    descricao TEXT
);

CREATE TABLE paciente_exame (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_paciente_exame'),
    prontuario_id BIGINT NOT NULL REFERENCES paciente_prontuario(id) ON DELETE CASCADE,
    data_exame TIMESTAMP WITHOUT TIME ZONE,
    tipo_exame_id BIGINT NOT NULL REFERENCES exame_tipo(id) ON DELETE RESTRICT,
    laboratorio VARCHAR(255),
    resultados TEXT,
    observacoes TEXT,
    profissional_id BIGINT NOT NULL REFERENCES profissional_saude(id) ON DELETE RESTRICT,
    hospital_unidade_id BIGINT NOT NULL REFERENCES hospital_unidade(id) ON DELETE RESTRICT
);

CREATE INDEX idx_paciente_exame_prontuario ON paciente_exame(prontuario_id);

-- ========================
-- CONSULTAS / CIRURGIAS / INTERNACOES
-- ========================
CREATE TABLE paciente_consulta (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_consulta'),
    prontuario_id BIGINT NOT NULL REFERENCES paciente_prontuario(id) ON DELETE CASCADE,
    data_consulta TIMESTAMP WITHOUT TIME ZONE,
    profissional_id BIGINT NOT NULL REFERENCES profissional_saude(id) ON DELETE RESTRICT,
    observacoes TEXT,
    sala_id BIGINT NOT NULL REFERENCES sala(id) ON DELETE RESTRICT,
    hospital_unidade_id BIGINT NOT NULL REFERENCES hospital_unidade(id) ON DELETE RESTRICT
);

CREATE INDEX idx_consulta_prontuario ON paciente_consulta(prontuario_id);

CREATE TABLE paciente_cirurgia (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_cirurgia'),
    prontuario_id BIGINT NOT NULL REFERENCES paciente_prontuario(id) ON DELETE CASCADE,
    nome VARCHAR(255),
    data_cirurgia TIMESTAMP WITHOUT TIME ZONE,
    profissional_responsavel_id BIGINT NOT NULL REFERENCES profissional_saude(id) ON DELETE RESTRICT,
    sala_id BIGINT NOT NULL REFERENCES sala(id) ON DELETE RESTRICT,
    hospital_unidade_id BIGINT NOT NULL REFERENCES hospital_unidade(id) ON DELETE RESTRICT,
    observacoes TEXT
);

CREATE INDEX idx_cirurgia_prontuario ON paciente_cirurgia(prontuario_id);

CREATE TABLE paciente_internacao (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_internacao'),
    prontuario_id BIGINT NOT NULL REFERENCES paciente_prontuario(id) ON DELETE CASCADE,
    data_internacao TIMESTAMP WITHOUT TIME ZONE,
    data_alta TIMESTAMP WITHOUT TIME ZONE,
    quarto_id BIGINT NOT NULL REFERENCES quarto(id) ON DELETE RESTRICT,
    motivo TEXT,
    profissional_responsavel_id BIGINT NOT NULL REFERENCES profissional_saude(id) ON DELETE RESTRICT,
    observacoes TEXT,
    hospital_unidade_id BIGINT NOT NULL REFERENCES hospital_unidade(id) ON DELETE RESTRICT
);

CREATE INDEX idx_internacao_prontuario ON paciente_internacao(prontuario_id);

-- ========================
-- DOENÇAS CRÔNICAS / ALERGIAS
-- ========================
CREATE TABLE doenca_cronica_modelo (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_doenca_modelo'),
    nome VARCHAR(255) NOT NULL,
    cid VARCHAR(50) NOT NULL,
    descricao TEXT
);

CREATE TABLE paciente_doenca_cronica (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_paciente_doenca'),
    prontuario_id BIGINT NOT NULL REFERENCES paciente_prontuario(id) ON DELETE CASCADE,
    doenca_modelo_id BIGINT NOT NULL REFERENCES doenca_cronica_modelo(id) ON DELETE RESTRICT,
    data_diagnostico TIMESTAMP WITHOUT TIME ZONE,
    estagio VARCHAR(100),
    observacoes TEXT,
    em_tratamento BOOLEAN DEFAULT TRUE
);

CREATE INDEX idx_paciente_doenca_prontuario ON paciente_doenca_cronica(prontuario_id);

CREATE TABLE alergia (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_alergia'),
    prontuario_id BIGINT NOT NULL REFERENCES paciente_prontuario(id) ON DELETE CASCADE,
    nome VARCHAR(200) NOT NULL,
    tipo INTEGER NOT NULL
);

CREATE INDEX idx_alergia_prontuario ON alergia(prontuario_id);

-- ========================
-- MEDICAMENTOS / MODELOS
-- ========================
CREATE TABLE medicamento_modelo (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_medicamento_modelo'),
    nome VARCHAR(255) NOT NULL,
    principio_ativo VARCHAR(255),
    fabricante VARCHAR(255),
    forma_farmaceutica VARCHAR(100),
    dosagem VARCHAR(100),
    indicacoes TEXT,
    contra_indicacoes TEXT
);

CREATE TABLE medicamento (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_medicamento'),
    modelo_id BIGINT NOT NULL REFERENCES medicamento_modelo(id) ON DELETE RESTRICT,
    lote VARCHAR(100),
    data_fabricacao DATE,
    data_validade DATE,
    quantidade_disponivel INTEGER DEFAULT 0,
    hospital_unidade_id BIGINT NOT NULL REFERENCES hospital_unidade(id) ON DELETE RESTRICT
);

CREATE INDEX idx_medicamento_modelo ON medicamento(modelo_id);
CREATE INDEX idx_medicamento_unidade ON medicamento(hospital_unidade_id);

-- ========================
-- RECEITA / ITENS DA RECEITA / PACIENTE_MEDICACAO (uso contínuo)
-- ========================
CREATE TABLE receita (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_receita'),
    paciente_id BIGINT NOT NULL REFERENCES paciente(id) ON DELETE CASCADE,
    profissional_id BIGINT NOT NULL REFERENCES profissional_saude(id) ON DELETE RESTRICT,
    data TIMESTAMP WITHOUT TIME ZONE DEFAULT now(),
    hospital_unidade_id BIGINT REFERENCES hospital_unidade(id) ON DELETE SET NULL
);

CREATE TABLE item_receita (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_item_receita'),
    receita_id BIGINT NOT NULL REFERENCES receita(id) ON DELETE CASCADE,
    medicamento_modelo_id BIGINT NOT NULL REFERENCES medicamento_modelo(id) ON DELETE RESTRICT,
    quantidade INTEGER,
    posologia VARCHAR(500)
);

CREATE INDEX idx_item_receita_receita ON item_receita(receita_id);

CREATE TABLE paciente_medicacao (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_paciente_medicacao'),
    prontuario_id BIGINT NOT NULL REFERENCES paciente_prontuario(id) ON DELETE CASCADE,
    medicamento_modelo_id BIGINT NOT NULL REFERENCES medicamento_modelo(id) ON DELETE RESTRICT,
    dosagem_prescrita VARCHAR(255),
    frequencia VARCHAR(100),
    via_administracao VARCHAR(100),
    observacoes TEXT,
    data_inicio TIMESTAMP WITHOUT TIME ZONE,
    data_fim TIMESTAMP WITHOUT TIME ZONE
);

CREATE INDEX idx_paciente_medicacao_prontuario ON paciente_medicacao(prontuario_id);

-- ========================
-- VACINAS / VACINA MODELO / VACINAÇÃO (registro)
-- ========================
CREATE TABLE vacina_modelo (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_vacina_modelo'),
    nome VARCHAR(255) NOT NULL,
    fabricante VARCHAR(255),
    tipo VARCHAR(100),
    indicacao TEXT,
    numero_doses INTEGER,
    intervalo_entre_doses INTERVAL
);

CREATE TABLE vacina (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_vacina'),
    vacina_modelo_id BIGINT NOT NULL REFERENCES vacina_modelo(id) ON DELETE RESTRICT,
    lote VARCHAR(100),
    data_producao DATE,
    data_validade DATE,
    quantidade_disponivel INTEGER DEFAULT 0,
    hospital_unidade_id BIGINT NOT NULL REFERENCES hospital_unidade(id) ON DELETE RESTRICT
);

CREATE TABLE paciente_vacinacao (
    id BIGINT PRIMARY KEY DEFAULT nextval('seq_paciente_vacinacao'),
    prontuario_id BIGINT NOT NULL REFERENCES paciente_prontuario(id) ON DELETE CASCADE,
    vacina_id BIGINT NOT NULL REFERENCES vacina(id) ON DELETE RESTRICT,
    profissional_responsavel_id BIGINT NOT NULL REFERENCES profissional_saude(id) ON DELETE RESTRICT,
    data_aplicacao TIMESTAMP WITHOUT TIME ZONE,
    dose_numero INTEGER,
    observacoes TEXT,
    hospital_unidade_id BIGINT NOT NULL REFERENCES hospital_unidade(id) ON DELETE RESTRICT
);

CREATE INDEX idx_paciente_vacinacao_prontuario ON paciente_vacinacao(prontuario_id);

-- ========================
-- ÍNDICES E CONSTRAINTS ADICIONAIS
-- ========================
CREATE INDEX idx_paciente_nome ON paciente(lower(nome));
CREATE INDEX idx_paciente_cns ON paciente(cns);
CREATE INDEX idx_profissional_registro ON profissional_saude(registro_profissional);